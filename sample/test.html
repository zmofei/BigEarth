<!DOCTYPE html>
    <html>
    <head>
        <title></title>
        <style type="text/css">
        body {
            color: #ffffff;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
            font-weight: bold;
            background-color: #000000;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            color: #fff;
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 5px;
            z-index: 100;
        }
        </style>
    </head>

    <body>
        <script src="http://threejs.org/build/three.min.js"></script>
        <div id="info">PointCloud with Custom, Dynamic Attribute</div>
        <script type="x-shader/x-vertex" id="vertexshader">
            attribute float displacement;
            varying vec3 vNormal;

            void main() {
              vNormal = normal;
              vec3 newPosition = position + normal * vec3(displacement);
              gl_Position = projectionMatrix *
                            modelViewMatrix *
                            vec4(newPosition, 1.0);
            }
        </script>
        <script type="x-shader/x-fragment" id="fragmentshader">
            // same name and type as VS
            varying vec3 vNormal;

            void main() {

              // calc the dot product and clamp
              // 0 -> 1 rather than -1 -> 1
              vec3 light = vec3(0.5, 0.2, 1.0);

              // ensure it's normalized
              light = normalize(light);

              // calculate the dot product of
              // the light to the vertex normal
              float dProd = max(0.0,
                                dot(vNormal, light));

              // feed into our frag colour
              gl_FragColor = vec4(dProd, // R
                                  dProd, // G
                                  dProd, // B
                                  1.0);  // A

            }
        </script>
        <script type="text/javascript">
        // PointCloud with Custom, Dynamic Attribute
        var renderer, scene, camera, cloud, uniforms, attributes;
        init();
        animate();
        function init() {
            // renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            // scene
            scene = new THREE.Scene();
            //camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 400;
            // attributes
            attributes = {
                displacement: {
                    type: 'f',
                    value: []
                },
            };

            // uniforms
            uniforms = {
                color: {
                    type: "c",
                    value: new THREE.Color(0x00ff00)
                },
            };
            var geometry = new THREE.SphereGeometry(100, 16, 16);

            var verts = geometry.vertices;
            var values = attributes.displacement.value;
            for (var v = 0; v < verts.length; v++) {
                values.push(Math.random() * 30);
            }

            // point cloud material
            var shaderMaterial = new THREE.ShaderMaterial({
                // uniforms: uniforms,
                attributes: attributes,
                vertexShader: document.getElementById('vertexshader').textContent,
                fragmentShader: document.getElementById('fragmentshader').textContent,
            });



            cloud = new THREE.Mesh(geometry, shaderMaterial);
            scene.add(cloud);
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            // for (var i = 0; i < attributes.alpha.value.length; i++) {
            //     // dynamically change alphas
            //     attributes.alpha.value[i] *= 0.995;
            //     if (attributes.alpha.value[i] < 0.2) {
            //         attributes.alpha.value[i] = 1.0;
            //     }
            // }
            // attributes.alpha.needsUpdate = true; // important!
            cloud.rotation.x += 0.005;
            cloud.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        </script>
    </body>

    </html>
